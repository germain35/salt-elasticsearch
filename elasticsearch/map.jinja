# -*- coding: utf-8 -*-
# vim: ft=jinja

{%- set os         = salt['grains.get']('os') %}
{%- set osrelease  = salt['grains.get']('osrelease') %}
{%- set oscodename = salt['grains.get']('oscodename') %}

{## start with defaults from defaults.yaml ##}
{% import_yaml "elasticsearch/defaults.yaml" as defaults %}

{% set elasticsearch = salt['pillar.get']( 'elasticsearch', default=defaults.elasticsearch, merge=True) %}

{% set version       = "%s"|format(elasticsearch.version) %}
{% set major_version = version.split('.')[0]|int %}

{% set os_family_map = salt['grains.filter_by']({
    'Debian': {
        'major_version': major_version,
        'pkg': 'elasticsearch',
        'jdk_pkg': 'openjdk-8-jre-headless',
        'service': 'elasticsearch',
        'systemd_override_config_file': '/etc/systemd/system/elasticsearch.service.d/override.conf',
        'home_dir': '/usr/share/elasticsearch',
        'plugin_bin': 'bin/elasticsearch-plugin',
        'defaults_file': '/etc/default/elasticsearch',
        'conf_file': '/etc/elasticsearch/elasticsearch.yml',
        'logging_file': '/etc/elasticsearch/log4j2.properties',
        'jvm_opts_file': '/etc/elasticsearch/jvm.options',
        'user': 'elasticsearch',
        'group': 'elasticsearch',
        'repo': {
            'humanname': 'elasticsearch',
            'name': 'deb https://artifacts.elastic.co/packages/' ~ major_version ~ '.x/apt stable main',
            'file': '/etc/apt/sources.list.d/elasticsearch.list',
            'key_url': 'https://artifacts.elastic.co/GPG-KEY-elasticsearch',
        },
        'curator': {
            'pkg': 'elasticsearch-curator',
            'conf_file': '/etc/elasticsearch/curator.yml',
            'action_conf_file': '/etc/elasticsearch/curator_actions.yml',
            'repo': {
                'humanname': 'elasticsearch-curator',
                'name': 'deb [arch=amd64] https://packages.elastic.co/curator/' ~ major_version ~ '/debian' ~ osrelease ~ ' stable main',
                'file': '/etc/apt/sources.list.d/elasticsearch.list',
                'key_url': 'https://packages.elastic.co/GPG-KEY-elasticsearch',
            }
        }
    },
}, grain='os_family', merge=salt['pillar.get']('elasticsearch:lookup'), default='Debian') %}

{% do elasticsearch.update(os_family_map) %}

